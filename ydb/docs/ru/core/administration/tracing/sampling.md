# Сэмплирование запросов

Для диагностики некоторых проблем с системой могут помочь трассы отдельных запросов. Для этого в {{ ydb-short-name }} есть механизм сэмплирования запросов. Чтобы включить сэмплирование, нужно добавить секцию `sampling` в `tracing_config`.

Секция `sampling` может обновляться с помощью механизма [динамической конфигурации](../../maintenance/manual/dynamic-config.md). Пример секции:

```yaml
tracing_config:
  # ...
  sampling:
    - fraction: 0.01
      level: 15
      max_rate_per_minute: 5
      max_burst: 2
```

В ней:
* `fraction` — доля сэмплируемых запросов. Обязательный параметр, ожидается дробное число от 0 до 1.
* `level` — уровень сэмплирования (уровни компонент определены [здесь](https://github.com/ydb-platform/ydb/blob/7f54b7193ead3595490220034854718679991aaa/ydb/library/wilson_ids/wilson.h)), компоненты с уровнем выше обозначенного не будут присутствовать в трассе. Семантика `level` может быть изменена в будущем. Обязательный параметр, ожидается целое число от 0 до 15 включительно.
* `max_rate_per_minute` — наибольшее среднее количество сэмплированных запросов в минуту. Обязательный, ожидается положительное целое число
* `max_burst` — максимальный всплекс количества сэмплированных запросов. Необязательный, значение по умолчанию --- 0.

Подробнее о значении параметров `max_rate_per_minute` и `max_burst` описано в секции [{#T}](./sampling.md#semantics).

{% note warning %}

В {{ ydb-short-name }} действует глобальное ограничение в 10 спанов в секунду, отправляемых с одного узла кластера. При его превышении спаны могут удаляться, что может приводить к неполным трассам.

{% endnote %}

## Выборочное сэмплирование запросов

Запросы так же можно сэмплировать по их типу или другим параметрам, например:

```yaml
tracing_config:
  # ...
  sampling:
    # ...
    - scope:
        request_type: KeyValue.ExecuteTransaction
      fraction: 0.05
      level: 10
      max_rate_per_minute: 10
```

В ней `scope` содержит набор селекторов, на данный момент поддерживаются селекторы:
* `request_type`
    
    Возможные значения:
    * KeyValue.AcquireLock
    * KeyValue.ExecuteTransaction
    * KeyValue.Read
    * KeyValue.ReadRange
    * KeyValue.ListRange
    * KeyValue.GetStorageChannelStatus

Запрос подходит под `scope`, если он удовлетворяет всем селекторам. Отсутствие `scope` равносильно пустому списку селекторов.

## Семантика настроек {#semantics}

### Rate limiting

Параметры `max_rate_per_minute` и `max_burst` используются для ограничения сверху на количество сэмплированных запросов. Используется вариация [leaky bucket](https://en.wikipedia.org/wiki/Leaky_bucket) с размером бакета равным `max_burst + 1`. Например, если `max_rate_per_minute = 60` и `max_burst = 0`, то при потоке в 1000 запросов в минуту будет трассироваться один запрос каждую секунду. Если же `max_burst = 20`, то при поступлении аналогичного потока запросов первые 21 будут оттрассированы, далее аналогично будет трассироваться один запрос в секунду.

### Scopes

Для каждого запроса выделяется список всех элементов в `sampling`, в scope которых он попадает. Запрос сэмплируется, если:

1. Хотя бы в одном из scope было принято решение о его сэмплировании.
1. Запрос подходит по *всем* ограничениям по rate в выбранных scope.

Уровень трассирования определяется, как максимальный из уровней среди scope, которые приняли решение о трассировании данного запроса.
